# 部署运维手册

面向平台运维的标准作业：环境准备、一键部署、监控配置、备份与恢复。涵盖Go服务（laojun/taishang-core）和Python服务（taishang-ai）的混合架构部署方案。

## 一、环境准备
- 系统：Linux (x86_64/ARM64)，Docker ≥ 24，Docker Compose ≥ v2
- 网络与安全：出入站策略；TLS/证书；镜像仓库访问权限
- 依赖：PostgreSQL、Redis、对象存储（可选）、日志与指标系统（如 ELK/Prometheus）
- 配置：环境变量与密钥管理（Vault/Env 文件）；分环境 `dev/staging/prod`

## 二、一键部署（脚本设计）
- 结构：`deploy/` 目录包含 `compose.yaml`、`env.*`、`deploy.sh`、`rollback.sh`
- 混合架构部署：
  - Go服务（laojun/taishang-core）：单二进制文件部署，轻量级容器
  - Python服务（taishang-ai）：依赖管理复杂，需要GPU支持，独立容器部署
- 流程：
  1) 校验环境与依赖版本（包括Python环境、CUDA、GPU驱动）
  2) 拉取镜像与构建（支持缓存）
  3) 生成与加载配置（`.env`、`secrets`、`config/*.yaml`）
  4) 启动服务（API/Admin/DB/Cache/Telemetry/AI服务）
  5) 运行数据库迁移与健康检查（`/healthz`、`/readyz`）
  6) 验证Go服务与Python服务间的gRPC通信
- 回滚：
  - 按标签回退镜像；切换 Compose profile；回滚迁移（仅安全变更）
  - 验证健康与功能；记录审计与变更单
  - 独立回滚策略：Go服务可独立回滚，Python服务回滚需考虑模型兼容性

### Python服务（taishang-ai）专项部署指南
- 环境要求：
  - Python 3.9+，推荐使用官方Python slim镜像作为基础镜像
  - GPU支持：NVIDIA驱动、CUDA 11.8+、cuDNN 8+
  - 依赖管理：使用requirements.txt或poetry.lock锁定依赖版本
- 容器化要点：
  - 多阶段构建：构建阶段安装依赖，运行阶段仅复制必要文件
  - 依赖预编译：使用wheel缓存加速构建
  - GPU支持：使用nvidia/cuda基础镜像，正确设置CUDA_VISIBLE_DEVICES
- 配置管理：
  - 模型路径：支持本地模型和云端模型下载
  - GPU资源配置：根据模型大小合理设置GPU内存限制
  - 性能调优：设置合理的并发请求数、批处理大小
- 健康检查：
  - HTTP健康检查：`/health`端点检查服务状态
  - GPU状态检查：验证GPU可用性和内存使用情况
  - 模型加载检查：确保关键模型已成功加载

## 三、监控与告警
- 通用指标：API QPS/错误率/延迟、任务队列深度、向量检索 P95、插件运行状态
- Go服务指标：
  - 内存使用：堆内存、栈内存、GC频率和耗时
  - 协程监控：协程数量、阻塞情况
  - HTTP指标：请求处理时间、连接池状态
- Python服务指标：
  - GPU使用率：GPU利用率、显存使用情况、温度
  - 模型推理：推理延迟、吞吐量、排队长度
  - Python进程：内存使用、CPU使用、GIL锁情况
  - 依赖服务：与taishang-core的gRPC连接状态和延迟
- 日志：结构化日志（traceId）；审计流与安全事件独立通道
- 追踪：OpenTelemetry；关键路由与任务链路采样；跨服务调用追踪
- 告警：阈值与异常检测；发布回滚与任务失败比率告警；GPU资源告警

## 四、备份与恢复
- 数据库：定时快照与增量备份；保留策略与异地容灾
- 对象存储：插件产物与模型文件校验与冗余；版本化管理
- Python服务专项备份：
  - 模型备份：大模型文件定期备份到对象存储，记录模型版本和校验和
  - 配置备份：Python服务配置文件、环境变量和依赖清单备份
  - 状态备份：模型加载状态、微调任务进度等运行时状态备份
- 恢复演练：季度演练；RPO/RTO 目标；步骤化脚本与核对清单
- 混合架构恢复顺序：
  1. 恢复基础服务（数据库、缓存、对象存储）
  2. 恢复Go服务（laojun/taishang-core）
  3. 恢复Python服务（taishang-ai）和模型文件
  4. 验证服务间通信和整体功能

### 备份恢复演练剧本（示例）
- 目标：验证在 `RPO≤5min / RTO≤30min` 约束下的完整恢复流程。
- 演练前置：冻结变更、导出当前配置、准备隔离演练环境与数据标签。
- 步骤：
  1) 触发最新快照备份与 WAL/增量归档校验；
  2) 模拟故障：停止数据库服务或损坏主库数据目录；
  3) 恢复：在新实例上挂载快照并回放增量；
  4) 校验：运行一致性检查（表行计数、校验和、关键业务查询对比）；
  5) 切换：应用指向新实例；逐步恢复业务流量；
  6) 回顾：收集指标与审计，形成演练报告与改进项。
- 验收标准：
  - 时间：整体恢复 ≤ 30 分钟；数据丢失 ≤ 5 分钟窗口；
  - 一致性：关键表与索引一致；核心查询结果一致；
  - 业务：核心接口成功率 ≥ 99%，延迟在基线 ±20% 范围内。

## 六、应急演练与验收标准
- 场景库：
  - 数据库主从切换失败；缓存雪崩；对象存储不可用；消息队列拥塞；
  - 部署失败回滚；密钥泄露处置；插件启动风暴与降级。
- 演练频率：季度综合演练；重大版本发布前专项演练。
- 组织与职责：明确指挥、执行、审计与回溯角色；演练前后召开评审会。
- 标准与度量：
  - 指标：MTTR、错误率、P95 延迟、队列深度、告警响应时间；
  - 文档：剧本、操作记录、审计、改进项闭环；
  - 验收：达到预设阈值与风险缓解方案落地。

## 五、操作规范
- 变更门禁：契约/测试覆盖/安全扫描达标方可发布
- 审计：变更与运维操作全量记入 `lao_audit_logs`；形成闭环
- 安全：最小权限原则；定期轮转密钥；加固容器与宿主机

## 七、混合架构部署最佳实践

### 服务编排与依赖管理
- 启动顺序：数据库 → 缓存 → Go服务 → Python服务
- 健康检查：设置合理的健康检查间隔和超时时间，考虑Python模型加载时间
- 依赖管理：明确Go服务与Python服务间的依赖关系，使用服务发现机制
- 资源隔离：Go服务与Python服务使用不同的资源池，避免资源竞争

### 跨语言通信优化
- gRPC配置：优化连接池大小、超时时间和重试策略
- 负载均衡：在Python服务前部署负载均衡器，支持多实例部署
- 协议兼容：确保Go与Python的protobuf定义版本一致
- 错误处理：统一错误码映射，提供清晰的跨服务错误信息

### GPU资源管理
- GPU共享：支持多个Python服务实例共享GPU资源
- 资源调度：根据模型大小和请求量动态分配GPU资源
- 监控告警：设置GPU使用率、显存使用率和温度告警阈值
- 容错处理：GPU故障时自动切换到备用GPU或降级服务

### 版本兼容性管理
- API版本：使用语义化版本控制，明确Go与Python服务间的API兼容性
- 模型版本：建立模型版本与服务版本的兼容性矩阵
- 独立发布：Go服务与Python服务可独立发布，但需验证兼容性
- 灰度发布：新版本Python服务先小范围验证，再全量发布

### 性能优化
- Go服务：优化并发处理、数据库连接池和缓存策略
- Python服务：优化模型加载、批处理大小和推理并行度
- 跨服务调用：减少不必要的跨服务调用，使用缓存减少延迟
- 资源配置：根据实际负载调整CPU、内存和GPU资源配置