# 可复用组件分析

## 概述

本文档分析太上老君AI平台中可复用的核心组件、方法和逻辑，为后续系统重构和新功能开发提供基础支撑。

## 后端可复用组件

### 1. 认证与授权组件

#### JWT令牌管理
```go
// 位置: internal/auth/service.go
// 功能: JWT令牌生成、验证、刷新
// 复用价值: 高 - 所有服务都需要认证功能

type TokenManager struct {
    secret []byte
    expiry time.Duration
}

// 生成令牌
func (tm *TokenManager) GenerateToken(userID int, username string, level int) (string, error)

// 验证令牌
func (tm *TokenManager) ValidateToken(tokenString string) (*Claims, error)

// 刷新令牌
func (tm *TokenManager) RefreshToken(tokenString string) (string, error)
```

**复用建议**:
- 提取为独立的pkg/auth包
- 支持多种令牌类型（访问令牌、刷新令牌）
- 添加令牌黑名单机制
- 支持不同硅基层级的令牌有效期

#### 权限验证中间件
```go
// 位置: internal/auth/service.go
// 功能: Gin中间件，验证用户权限
// 复用价值: 高 - 所有需要权限控制的接口都需要

func (s *Service) AuthMiddleware() gin.HandlerFunc
func (s *Service) RequireLevel(minLevel int) gin.HandlerFunc
func (s *Service) RequirePermission(permission string) gin.HandlerFunc
```

**复用建议**:
- 支持细粒度权限控制
- 添加硅基层级验证
- 支持动态权限检查
- 集成审计日志

### 2. 数据库操作组件

#### 数据库连接管理
```go
// 位置: pkg/database/connection.go
// 功能: 数据库连接池管理
// 复用价值: 高 - 所有服务都需要数据库连接

type DatabaseManager struct {
    db *sql.DB
    config *Config
}

func NewConnection() (*sql.DB, error)
func (dm *DatabaseManager) GetConnection() *sql.DB
func (dm *DatabaseManager) Close() error
```

**复用建议**:
- 支持多数据库连接
- 添加连接池监控
- 支持读写分离
- 集成事务管理

#### 通用CRUD操作
```go
// 建议新增: pkg/database/crud.go
// 功能: 通用的增删改查操作
// 复用价值: 高 - 减少重复代码

type CRUDService[T any] struct {
    db *sql.DB
    tableName string
}

func (c *CRUDService[T]) Create(entity *T) error
func (c *CRUDService[T]) GetByID(id int) (*T, error)
func (c *CRUDService[T]) Update(entity *T) error
func (c *CRUDService[T]) Delete(id int) error
func (c *CRUDService[T]) List(filters map[string]interface{}) ([]*T, error)
```

### 3. HTTP服务组件

#### 统一响应格式
```go
// 建议新增: pkg/response/response.go
// 功能: 统一API响应格式
// 复用价值: 高 - 保证API一致性

type Response struct {
    Code    int         `json:"code"`
    Message string      `json:"message"`
    Data    interface{} `json:"data,omitempty"`
    Meta    *Meta       `json:"meta,omitempty"`
}

type Meta struct {
    Page       int `json:"page,omitempty"`
    PageSize   int `json:"page_size,omitempty"`
    Total      int `json:"total,omitempty"`
    TotalPages int `json:"total_pages,omitempty"`
}

func Success(data interface{}) *Response
func Error(code int, message string) *Response
func Paginated(data interface{}, meta *Meta) *Response
```

#### 请求验证组件
```go
// 建议新增: pkg/validator/validator.go
// 功能: 统一请求参数验证
// 复用价值: 中 - 提高代码质量

type Validator struct {
    validator *validator.Validate
}

func (v *Validator) ValidateStruct(s interface{}) error
func (v *Validator) ValidateField(field interface{}, tag string) error
```

### 4. 日志与监控组件

#### 结构化日志
```go
// 建议新增: pkg/logger/logger.go
// 功能: 统一日志格式和输出
// 复用价值: 高 - 便于日志分析和监控

type Logger struct {
    logger *logrus.Logger
    service string
}

func (l *Logger) Info(message string, fields map[string]interface{})
func (l *Logger) Error(message string, err error, fields map[string]interface{})
func (l *Logger) Warn(message string, fields map[string]interface{})
func (l *Logger) Debug(message string, fields map[string]interface{})
```

#### 性能监控
```go
// 建议新增: pkg/metrics/metrics.go
// 功能: 性能指标收集
// 复用价值: 中 - 系统监控必需

type MetricsCollector struct {
    counters map[string]*prometheus.CounterVec
    histograms map[string]*prometheus.HistogramVec
}

func (mc *MetricsCollector) IncrementCounter(name string, labels map[string]string)
func (mc *MetricsCollector) RecordDuration(name string, duration time.Duration, labels map[string]string)
```

## 前端可复用组件

### 1. 状态管理组件

#### Redux Slice模板
```typescript
// 位置: src/store/slices/
// 功能: 标准化的Redux状态管理
// 复用价值: 高 - 统一状态管理模式

interface BaseSliceState<T> {
  items: T[];
  currentItem: T | null;
  loading: boolean;
  error: string | null;
  pagination: {
    page: number;
    pageSize: number;
    total: number;
  };
}

// 通用异步thunk模板
const createAsyncThunks = <T>(name: string, api: any) => ({
  fetchItems: createAsyncThunk(`${name}/fetchItems`, api.getAll),
  fetchItem: createAsyncThunk(`${name}/fetchItem`, api.getById),
  createItem: createAsyncThunk(`${name}/createItem`, api.create),
  updateItem: createAsyncThunk(`${name}/updateItem`, api.update),
  deleteItem: createAsyncThunk(`${name}/deleteItem`, api.delete),
});
```

#### 通用选择器
```typescript
// 建议新增: src/store/selectors/base.ts
// 功能: 通用的状态选择器
// 复用价值: 中 - 减少重复代码

export const createBaseSelectors = <T>(sliceName: string) => ({
  selectItems: (state: RootState) => state[sliceName].items,
  selectCurrentItem: (state: RootState) => state[sliceName].currentItem,
  selectLoading: (state: RootState) => state[sliceName].loading,
  selectError: (state: RootState) => state[sliceName].error,
  selectPagination: (state: RootState) => state[sliceName].pagination,
});
```

### 2. UI组件库

#### 基础组件
```typescript
// 位置: src/components/common/
// 功能: 可复用的UI组件
// 复用价值: 高 - 保证UI一致性

// 按钮组件
interface ButtonProps {
  variant: 'primary' | 'secondary' | 'danger';
  size: 'small' | 'medium' | 'large';
  loading?: boolean;
  disabled?: boolean;
  onClick?: () => void;
  children: React.ReactNode;
}

// 表单组件
interface FormFieldProps {
  label: string;
  name: string;
  type: 'text' | 'email' | 'password' | 'select' | 'textarea';
  required?: boolean;
  validation?: ValidationRule[];
  options?: Option[]; // for select
}

// 数据表格组件
interface DataTableProps<T> {
  data: T[];
  columns: Column<T>[];
  loading?: boolean;
  pagination?: PaginationConfig;
  onRowClick?: (row: T) => void;
  onSort?: (field: string, direction: 'asc' | 'desc') => void;
}
```

#### 布局组件
```typescript
// 位置: src/components/layout/
// 功能: 页面布局组件
// 复用价值: 高 - 统一页面结构

// 页面容器
interface PageContainerProps {
  title: string;
  breadcrumb?: BreadcrumbItem[];
  actions?: React.ReactNode;
  children: React.ReactNode;
}

// 卡片容器
interface CardProps {
  title?: string;
  extra?: React.ReactNode;
  loading?: boolean;
  children: React.ReactNode;
}
```

### 3. 工具函数

#### API请求封装
```typescript
// 位置: src/services/api.ts
// 功能: 统一的API请求处理
// 复用价值: 高 - 统一错误处理和请求格式

class ApiClient {
  private baseURL: string;
  private token: string | null;

  constructor(baseURL: string) {
    this.baseURL = baseURL;
    this.token = localStorage.getItem('token');
  }

  async request<T>(config: RequestConfig): Promise<ApiResponse<T>>
  async get<T>(url: string, params?: any): Promise<ApiResponse<T>>
  async post<T>(url: string, data?: any): Promise<ApiResponse<T>>
  async put<T>(url: string, data?: any): Promise<ApiResponse<T>>
  async delete<T>(url: string): Promise<ApiResponse<T>>
}
```

#### 表单验证工具
```typescript
// 建议新增: src/utils/validation.ts
// 功能: 通用表单验证规则
// 复用价值: 中 - 提高开发效率

export const validationRules = {
  required: (message?: string) => ({ required: true, message: message || '此字段为必填项' }),
  email: (message?: string) => ({ type: 'email', message: message || '请输入有效的邮箱地址' }),
  minLength: (min: number, message?: string) => ({ 
    min, 
    message: message || `最少需要${min}个字符` 
  }),
  pattern: (pattern: RegExp, message: string) => ({ pattern, message }),
};
```

## AI服务可复用组件

### 1. 自然语言处理组件

#### 文本预处理
```python
# 位置: ai-services/src/shared/nlp/preprocessor.py
# 功能: 统一的文本预处理
# 复用价值: 高 - 所有NLP任务的基础

class TextPreprocessor:
    """
    文本预处理器
    
    功能说明：提供统一的文本清洗、分词、标准化等预处理功能
    开发人员：Li da
    开发时间：2025年10月1日
    """
    
    def __init__(self, language: str = 'zh'):
        self.language = language
        self.tokenizer = self._load_tokenizer()
    
    def clean_text(self, text: str) -> str:
        """清洗文本，移除特殊字符和多余空格"""
        pass
    
    def tokenize(self, text: str) -> List[str]:
        """文本分词"""
        pass
    
    def normalize(self, text: str) -> str:
        """文本标准化"""
        pass
```

#### 语义相似度计算
```python
# 建议新增: ai-services/src/shared/nlp/similarity.py
# 功能: 计算文本语义相似度
# 复用价值: 高 - 智慧匹配和推荐的核心

class SemanticSimilarity:
    """
    语义相似度计算器
    
    功能说明：计算文本间的语义相似度，支持多种算法
    开发人员：Li da
    开发时间：2025年10月1日
    """
    
    def __init__(self, model_name: str = 'sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2'):
        self.model = SentenceTransformer(model_name)
    
    def compute_similarity(self, text1: str, text2: str) -> float:
        """计算两个文本的相似度"""
        pass
    
    def find_most_similar(self, query: str, candidates: List[str], top_k: int = 5) -> List[Tuple[str, float]]:
        """找到最相似的候选文本"""
        pass
```

### 2. 机器学习组件

#### 模型管理器
```python
# 建议新增: ai-services/src/shared/ml/model_manager.py
# 功能: 统一的模型加载和管理
# 复用价值: 高 - 所有AI服务的基础

class ModelManager:
    """
    模型管理器
    
    功能说明：统一管理AI模型的加载、缓存和版本控制
    开发人员：Li da
    开发时间：2025年10月1日
    """
    
    def __init__(self, model_cache_dir: str = './models'):
        self.cache_dir = model_cache_dir
        self.loaded_models = {}
    
    def load_model(self, model_name: str, model_type: str) -> Any:
        """加载指定模型"""
        pass
    
    def get_model(self, model_name: str) -> Any:
        """获取已加载的模型"""
        pass
    
    def unload_model(self, model_name: str) -> None:
        """卸载模型释放内存"""
        pass
```

#### 特征提取器
```python
# 建议新增: ai-services/src/shared/ml/feature_extractor.py
# 功能: 通用特征提取
# 复用价值: 中 - 机器学习任务的基础

class FeatureExtractor:
    """
    特征提取器
    
    功能说明：从文本、用户行为等数据中提取机器学习特征
    开发人员：Li da
    开发时间：2025年10月1日
    """
    
    def extract_text_features(self, text: str) -> Dict[str, float]:
        """提取文本特征"""
        pass
    
    def extract_user_features(self, user_data: Dict) -> Dict[str, float]:
        """提取用户特征"""
        pass
    
    def extract_behavioral_features(self, behavior_data: List[Dict]) -> Dict[str, float]:
        """提取行为特征"""
        pass
```

### 3. 数据处理组件

#### 向量数据库接口
```python
# 建议新增: ai-services/src/shared/storage/vector_store.py
# 功能: 统一的向量数据库操作
# 复用价值: 高 - 语义搜索和推荐的基础

class VectorStore:
    """
    向量数据库接口
    
    功能说明：提供统一的向量存储和检索接口
    开发人员：Li da
    开发时间：2025年10月1日
    """
    
    def __init__(self, store_type: str = 'pinecone', config: Dict = None):
        self.store_type = store_type
        self.client = self._init_client(config)
    
    def store_vectors(self, vectors: List[List[float]], metadata: List[Dict], ids: List[str]) -> None:
        """存储向量和元数据"""
        pass
    
    def search_similar(self, query_vector: List[float], top_k: int = 10, filter_dict: Dict = None) -> List[Dict]:
        """搜索相似向量"""
        pass
    
    def delete_vectors(self, ids: List[str]) -> None:
        """删除向量"""
        pass
```

## 配置管理组件

### 环境配置
```go
// 建议新增: pkg/config/config.go
// 功能: 统一的配置管理
// 复用价值: 高 - 所有服务都需要配置管理

type Config struct {
    Server   ServerConfig   `yaml:"server"`
    Database DatabaseConfig `yaml:"database"`
    Redis    RedisConfig    `yaml:"redis"`
    Auth     AuthConfig     `yaml:"auth"`
    AI       AIConfig       `yaml:"ai"`
}

func LoadConfig(configPath string) (*Config, error)
func (c *Config) Validate() error
func (c *Config) GetByEnvironment(env string) *Config
```

## 复用优先级建议

### 高优先级（立即复用）
1. JWT令牌管理组件
2. 数据库连接管理
3. 统一响应格式
4. Redux Slice模板
5. API请求封装
6. 文本预处理组件
7. 配置管理组件

### 中优先级（逐步复用）
1. 权限验证中间件
2. 通用CRUD操作
3. 结构化日志组件
4. UI组件库
5. 语义相似度计算
6. 模型管理器

### 低优先级（按需复用）
1. 性能监控组件
2. 请求验证组件
3. 表单验证工具
4. 特征提取器
5. 向量数据库接口

## 复用实施建议

### 1. 代码重构步骤
1. **提取公共组件** - 将可复用代码提取到独立包
2. **标准化接口** - 定义统一的接口规范
3. **添加文档** - 为每个组件添加详细文档
4. **编写测试** - 确保组件的可靠性
5. **版本管理** - 建立组件版本管理机制

### 2. 组件库建设
1. **建立组件仓库** - 创建独立的组件库项目
2. **发布机制** - 建立组件发布和更新机制
3. **使用文档** - 提供详细的使用指南
4. **示例代码** - 为每个组件提供使用示例

### 3. 质量保证
1. **代码审查** - 所有组件都需要代码审查
2. **自动化测试** - 建立完整的测试覆盖
3. **性能测试** - 确保组件性能符合要求
4. **兼容性测试** - 确保跨平台兼容性

---

**文档版本**: v1.0  
**创建时间**: 2025年1月  
**创建人员**: Li da  
**更新频率**: 每两周更新