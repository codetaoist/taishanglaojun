# 太上老君监控系统 Grafana 数据源配置

apiVersion: 1

# 数据源列表
datasources:
  # Prometheus 数据源
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: true
    jsonData:
      timeInterval: "5s"
      queryTimeout: "60s"
      httpMethod: "POST"
      manageAlerts: true
      alertmanagerUid: "alertmanager"
    secureJsonData: {}

  # InfluxDB 数据源
  - name: InfluxDB
    type: influxdb
    access: proxy
    url: http://influxdb:8086
    database: monitoring
    user: admin
    secureJsonData:
      password: admin123
    jsonData:
      version: "InfluxQL"
      timeInterval: "10s"
      httpMode: "GET"
    editable: true

  # InfluxDB v2 数据源
  - name: InfluxDB-v2
    type: influxdb
    access: proxy
    url: http://influxdb:8086
    jsonData:
      version: "Flux"
      organization: taishanglaojun
      defaultBucket: monitoring
      tlsSkipVerify: true
    secureJsonData:
      token: monitoring-token-123456789
    editable: true

  # Elasticsearch 数据源
  - name: Elasticsearch
    type: elasticsearch
    access: proxy
    url: http://elasticsearch:9200
    database: "[logs-]YYYY.MM.DD"
    jsonData:
      interval: "Daily"
      timeField: "@timestamp"
      esVersion: "8.0.0"
      maxConcurrentShardRequests: 5
      logMessageField: "message"
      logLevelField: "level"
    editable: true

  # Jaeger 数据源
  - name: Jaeger
    type: jaeger
    access: proxy
    url: http://jaeger:16686
    jsonData:
      tracesToLogs:
        datasourceUid: "elasticsearch"
        tags: ["job", "instance", "pod", "namespace"]
        mappedTags: [
          {
            key: "service.name",
            value: "service"
          }
        ]
        mapTagNamesEnabled: true
        spanStartTimeShift: "1h"
        spanEndTimeShift: "1h"
        filterByTraceID: false
        filterBySpanID: false
      tracesToMetrics:
        datasourceUid: "prometheus"
        tags: [
          {
            key: "service.name",
            value: "service"
          },
          {
            key: "job"
          }
        ]
        queries: [
          {
            name: "Sample query",
            query: "sum(rate(traces_spanmetrics_latency_bucket{$$__tags}[5m]))"
          }
        ]
      nodeGraph:
        enabled: true
    editable: true

  # Loki 数据源（如果使用）
  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100
    jsonData:
      maxLines: 1000
      derivedFields:
        - datasourceUid: "jaeger"
          matcherRegex: "traceID=(\\w+)"
          name: "TraceID"
          url: "$${__value.raw}"
    editable: true

  # TestData 数据源（用于测试）
  - name: TestData
    type: testdata
    access: proxy
    orgId: 1
    uid: testdata
    editable: false
    jsonData: {}

# 删除不存在的数据源
deleteDatasources:
  - name: "Old Prometheus"
    orgId: 1
  - name: "Old InfluxDB"
    orgId: 1