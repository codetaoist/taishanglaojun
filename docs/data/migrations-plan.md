# 数据迁移策略（版本化与回滚）

统一迁移策略，保障分域与前缀落库的一致性与可回滚性。[0]

## 版本命名与目录
- 目录：`db/migrations/`
- 命名：`V{序号}__{动作描述}.sql`，如 `V1__init_lao.sql`, `V2__init_tai.sql`
- 规则：一个文件一个原子迁移；必须具备回滚脚本或说明。

## 原子迁移范式
- 创建表与索引：先表后索引；唯一索引命名规范 `idx_<table>_<columns>`。
- 外键与约束：显式声明；约束命名规范 `fk_<table>_<ref>`。
- 兼容性：字段新增默认值与非空策略；拆分大变更为多步。

## 回滚策略
- 新表回滚：`DROP TABLE`或保留并标记停用；谨慎删除生产数据。
- 字段回滚：删除或恢复；涉及数据迁移需备份与恢复脚本。
- 索引回滚：`DROP INDEX`；评估性能影响。

## 审计与验证
- 迁移记录：变更人、时间、环境、摘要；纳入审计。
- 验证：迁移后运行契约测试与健康检查；对关键路径做E2E验证。

> 参考：[0] https://www.doubao.com/thread/w1745a17f59b91183