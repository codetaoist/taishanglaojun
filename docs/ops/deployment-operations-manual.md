# 部署运维手册

面向平台运维的标准作业：环境准备、一键部署、监控配置、备份与恢复。

## 一、环境准备
- 系统：Linux (x86_64/ARM64)，Docker ≥ 24，Docker Compose ≥ v2
- 网络与安全：出入站策略；TLS/证书；镜像仓库访问权限
- 依赖：PostgreSQL、Redis、对象存储（可选）、日志与指标系统（如 ELK/Prometheus）
- 配置：环境变量与密钥管理（Vault/Env 文件）；分环境 `dev/staging/prod`

## 二、一键部署（脚本设计）
- 结构：`deploy/` 目录包含 `compose.yaml`、`env.*`、`deploy.sh`、`rollback.sh`
- 流程：
  1) 校验环境与依赖版本
  2) 拉取镜像与构建（支持缓存）
  3) 生成与加载配置（`.env`、`secrets`、`config/*.yaml`）
  4) 启动服务（API/Admin/DB/Cache/Telemetry）
  5) 运行数据库迁移与健康检查（`/healthz`、`/readyz`）
- 回滚：
  - 按标签回退镜像；切换 Compose profile；回滚迁移（仅安全变更）
  - 验证健康与功能；记录审计与变更单

## 三、监控与告警
- 指标：API QPS/错误率/延迟、任务队列深度、向量检索 P95、插件运行状态
- 日志：结构化日志（traceId）；审计流与安全事件独立通道
- 追踪：OpenTelemetry；关键路由与任务链路采样
- 告警：阈值与异常检测；发布回滚与任务失败比率告警

## 四、备份与恢复
- 数据库：定时快照与增量备份；保留策略与异地容灾
- 对象存储：插件产物与模型文件校验与冗余；版本化管理
- 恢复演练：季度演练；RPO/RTO 目标；步骤化脚本与核对清单

### 备份恢复演练剧本（示例）
- 目标：验证在 `RPO≤5min / RTO≤30min` 约束下的完整恢复流程。
- 演练前置：冻结变更、导出当前配置、准备隔离演练环境与数据标签。
- 步骤：
  1) 触发最新快照备份与 WAL/增量归档校验；
  2) 模拟故障：停止数据库服务或损坏主库数据目录；
  3) 恢复：在新实例上挂载快照并回放增量；
  4) 校验：运行一致性检查（表行计数、校验和、关键业务查询对比）；
  5) 切换：应用指向新实例；逐步恢复业务流量；
  6) 回顾：收集指标与审计，形成演练报告与改进项。
- 验收标准：
  - 时间：整体恢复 ≤ 30 分钟；数据丢失 ≤ 5 分钟窗口；
  - 一致性：关键表与索引一致；核心查询结果一致；
  - 业务：核心接口成功率 ≥ 99%，延迟在基线 ±20% 范围内。

## 六、应急演练与验收标准
- 场景库：
  - 数据库主从切换失败；缓存雪崩；对象存储不可用；消息队列拥塞；
  - 部署失败回滚；密钥泄露处置；插件启动风暴与降级。
- 演练频率：季度综合演练；重大版本发布前专项演练。
- 组织与职责：明确指挥、执行、审计与回溯角色；演练前后召开评审会。
- 标准与度量：
  - 指标：MTTR、错误率、P95 延迟、队列深度、告警响应时间；
  - 文档：剧本、操作记录、审计、改进项闭环；
  - 验收：达到预设阈值与风险缓解方案落地。

## 五、操作规范
- 变更门禁：契约/测试覆盖/安全扫描达标方可发布
- 审计：变更与运维操作全量记入 `lao_audit_logs`；形成闭环
- 安全：最小权限原则；定期轮转密钥；加固容器与宿主机